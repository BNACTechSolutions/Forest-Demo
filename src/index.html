<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BioCLIP Species Identifier</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; margin-bottom: 10px; }
    .subtitle { color: #666; margin-bottom: 20px; }
    
    #drop {
      border: 3px dashed #0066cc;
      padding: 40px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
    }
    #drop:hover { background: #f0f5ff; border-color: #003399; }
    #drop.dragging { background: #e6f0ff; border-color: #003399; }
    
    #fileInput { display: none; }
    .file-label { color: #0066cc; font-weight: 500; }
    
    .container { display: flex; gap: 20px; margin-top: 20px; }
    #preview-container { flex: 0 0 40%; }
    #preview { 
      max-width: 100%; 
      height: auto; 
      display: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #detection-canvas {
      max-width: 100%;
      height: auto;
      display: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    #status.loading { background: #e6f0ff; color: #0066cc; }
    #status.success { background: #e6ffe6; color: #006600; }
    #status.error { background: #ffe6e6; color: #cc0000; }
    
    #results-container { flex: 1; }
    #results { 
      background: white;
      border-radius: 8px;
      padding: 15px;
      display: none;
    }
    
    .detection-group {
      background: #f9f9f9;
      border-left: 4px solid #0066cc;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
    }
    
    .detection-header {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .species-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .species-item:last-child { border-bottom: none; }
    
    .species-name { font-weight: 500; color: #0066cc; }
    .species-conf {
      color: #666;
      font-size: 13px;
      margin-left: 8px;
    }
    
    .detector-conf {
      color: #999;
      font-size: 12px;
      margin-top: 4px;
    }
    
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    
    .no-detections {
      color: #999;
      font-style: italic;
      padding: 20px;
      text-align: center;
    }
    
    .options {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .option-group {
      margin-bottom: 12px;
    }
    
    .option-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .option-group input { cursor: pointer; }
    
    input[type="number"], input[type="range"] {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .slider-value {
      display: inline-block;
      min-width: 40px;
      text-align: right;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>ü¶Å BioCLIP Species Identifier</h1>
  <p class="subtitle">AI-powered wildlife detection and classification</p>
  
  <div id="drop">
    <p style="margin: 0 0 10px 0; font-size: 16px;">üì∏ Drop an image here</p>
    <p style="margin: 0; color: #666; font-size: 14px;">or <span class="file-label">browse</span> <input id="fileInput" type="file" accept="image/*" /></p>
  </div>

  <div class="container">
    <div id="preview-container">
      <img id="preview" alt="preview" />
      <canvas id="detection-canvas"></canvas>
      <div id="status"></div>
    </div>
    
    <div id="results-container">
      <div id="results"></div>
      
      <div class="options">
        <div class="option-group">
          <label>
            <input type="checkbox" id="runSam" /> Run SAM masks
            <span style="color: #999; font-size: 12px;">(slower, more precise)</span>
          </label>
        </div>
        <div class="option-group">
          <label>
            Detector Threshold:
            <input type="range" id="detectorThreshold" min="0" max="1" step="0.05" value="0.35" />
            <span class="slider-value" id="thresholdValue">0.35</span>
          </label>
        </div>
        <div class="option-group">
          <label>
            Top-K Species:
            <input type="number" id="topkSpecies" min="1" max="5" value="1" style="width: 60px;" />
          </label>
        </div>
      </div>
    </div>
  </div>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const detectionCanvas = document.getElementById('detection-canvas');
const status = document.getElementById('status');
const results = document.getElementById('results');
const runSamCheckbox = document.getElementById('runSam');
const detectorThresholdSlider = document.getElementById('detectorThreshold');
const thresholdValue = document.getElementById('thresholdValue');
const topkSpeciesInput = document.getElementById('topkSpecies');

// Update threshold display
detectorThresholdSlider.addEventListener('input', e => {
  thresholdValue.textContent = parseFloat(e.target.value).toFixed(2);
});

// Drag and drop
drop.addEventListener('dragover', e => { 
  e.preventDefault(); 
  drop.classList.add('dragging');
});
drop.addEventListener('dragleave', e => { 
  e.preventDefault(); 
  drop.classList.remove('dragging');
});
drop.addEventListener('drop', e => { 
  e.preventDefault(); 
  drop.classList.remove('dragging');
  handleFiles(e.dataTransfer.files); 
});
drop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => handleFiles(e.target.files));

function setStatus(message, type = 'loading') {
  status.textContent = message;
  status.className = type;
}

function drawDetections(imageUrl, detections) {
  const img = new Image();
  img.onload = function() {
    detectionCanvas.width = img.width;
    detectionCanvas.height = img.height;
    const ctx = detectionCanvas.getContext('2d');
    
    // Draw image
    ctx.drawImage(img, 0, 0);
    
    // Draw detections
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    
    detections.forEach((det, idx) => {
      const [x1, y1, x2, y2] = det.bbox;
      const color = colors[idx % colors.length];
      
      // Draw box
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
      
      // Draw label
      const label = det.species || det.label;
      const confidence = det.species_confidence !== null ? 
        (det.species_confidence * 100).toFixed(1) : 
        (det.detector_confidence * 100).toFixed(1);
      const text = `${label} ${confidence}%`;
      
      ctx.fillStyle = color;
      ctx.fillRect(x1, y1 - 25, ctx.measureText(text).width + 10, 25);
      ctx.fillStyle = 'white';
      ctx.font = 'bold 12px Arial';
      ctx.fillText(text, x1 + 5, y1 - 8);
    });
    
    detectionCanvas.style.display = 'block';
  };
  img.src = imageUrl;
}

async function handleFiles(files) {
  if (!files || files.length === 0) return;
  const file = files[0];
  
  // Show preview
  const previewUrl = URL.createObjectURL(file);
  preview.src = previewUrl;
  preview.style.display = 'block';
  detectionCanvas.style.display = 'none';
  results.innerHTML = '';
  results.style.display = 'none';
  
  setStatus('‚è≥ Uploading & identifying...', 'loading');

  try {
    const form = new FormData();
    form.append('file', file);  // Must be 'file', not 'image'
    form.append('run_sam', runSamCheckbox.checked);
    form.append('detector_threshold', detectorThresholdSlider.value);
    form.append('topk_species', topkSpeciesInput.value);

    const resp = await fetch('http://localhost:8000/identify', {
      method: 'POST',
      body: form
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({error: 'Unknown error'}));
      setStatus('‚ùå Error: ' + (err?.detail || err?.error || resp.statusText), 'error');
      return;
    }

    const data = await resp.json();
    
    // Show warnings if any
    if (data.warnings && data.warnings.length > 0) {
      results.innerHTML += data.warnings.map(w => `<div class="warning">‚ö†Ô∏è ${w}</div>`).join('');
    }
    
    // Process detections
    if (!data.detections || data.detections.length === 0) {
      results.innerHTML += '<div class="no-detections">No detections found</div>';
      results.style.display = 'block';
      setStatus('‚úì Analysis complete (no detections)', 'success');
      return;
    }

    // Draw detections on canvas
    drawDetections(previewUrl, data.detections);
    
    // Display results
    let resultsHtml = '';
    data.detections.forEach((det, idx) => {
      const [x1, y1, x2, y2] = det.bbox;
      const width = Math.round(x2 - x1);
      const height = Math.round(y2 - y1);
      
      resultsHtml += `
        <div class="detection-group">
          <div class="detection-header">
            Detection #${idx + 1}: ${det.label.toUpperCase()}
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
            Pos: (${Math.round(x1)}, ${Math.round(y1)}) | Size: ${width}√ó${height}px
          </div>
      `;
      
      if (det.species) {
        resultsHtml += `
          <div class="species-item">
            <span class="species-name">${det.species}</span>
            <span class="species-conf">${(det.species_confidence * 100).toFixed(1)}% confident</span>
          </div>
        `;
        
        if (det.extra && det.extra.topk && det.extra.topk.length > 1) {
          resultsHtml += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 12px; color: #666;">';
          resultsHtml += '<strong style="color: #333;">Other candidates:</strong><br>';
          det.extra.topk.slice(1).forEach(item => {
            resultsHtml += `${item.species}: ${(item.confidence * 100).toFixed(1)}%<br>`;
          });
          resultsHtml += '</div>';
        }
      }
      
      if (det.detector_confidence) {
        resultsHtml += `<div class="detector-conf">Detector confidence: ${(det.detector_confidence * 100).toFixed(1)}%</div>`;
      }
      
      resultsHtml += '</div>';
    });
    
    results.innerHTML += resultsHtml;
    results.style.display = 'block';
    
    setStatus(`‚úì Found ${data.detections.length} detection(s)`, 'success');
  } catch (err) {
    console.error(err);
    setStatus('‚ùå Network error: ' + err.message, 'error');
  }
}
</script>
</body>
</html>
